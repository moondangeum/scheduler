import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, query, where, deleteDoc } from 'firebase/firestore';
import { ChevronLeftIcon, ChevronRightIcon, PlusCircleIcon, PencilIcon, TrashIcon, XCircleIcon, CheckCircleIcon } from '@heroicons/react/24/solid';

// 파비콘 SVG
const faviconSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z" fill="#fff"/>
</svg>`;

// Headless UI의 @headlessui/react 대신 Heroicons를 사용하여 간단하게 아이콘을 추가합니다.
// <script src="https://cdn.tailwindcss.com"></script>
// <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
// <style>
//   body { font-family: 'Inter', sans-serif; }
//   .modal-overlay {
//     background-color: rgba(0, 0, 0, 0.75);
//     backdrop-filter: blur(5px);
//   }
//   .calendar-day-cell:hover .day-label {
//     background-color: #f3f4f6;
//     color: #4b5563;
//   }
//   .rounded-button {
//     transition: transform 0.1s ease-in-out;
//   }
//   .rounded-button:active {
//     transform: scale(0.95);
//   }
//   .transition-transform-scale {
//     transition-property: transform;
//     transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
//     transition-duration: 150ms;
//     transform: scale(1);
//   }
// </style>

const App = () => {
    // Firebase 설정과 연결
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);

    // 날짜 상태
    const [currentDate, setCurrentDate] = useState(new Date());

    // 모달 상태
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [modalTitle, setModalTitle] = useState('');
    const [modalDescription, setModalDescription] = useState('');
    const [selectedDate, setSelectedDate] = useState(null);
    const [editingEvent, setEditingEvent] = useState(null);

    // 이벤트 상태
    const [events, setEvents] = useState([]);

    useEffect(() => {
        // Firebase 초기화
        let app;
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            app = initializeApp(firebaseConfig);
            setDb(getFirestore(app));
            setAuth(getAuth(app));
        } catch (e) {
            console.error("Firebase 초기화 오류:", e);
        }
    }, []);

    useEffect(() => {
        if (auth && db) {
            const unsub = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    const anonymousUser = await signInAnonymously(auth);
                    setUserId(anonymousUser.user.uid);
                }
                setIsAuthReady(true);
            });
            return () => unsub();
        }
    }, [auth, db]);

    // 이벤트 실시간 동기화
    useEffect(() => {
        if (!isAuthReady || !db || !userId) return;

        const eventsCollection = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'events');
        const q = query(eventsCollection);

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedEvents = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setEvents(fetchedEvents);
        }, (error) => {
            console.error("이벤트 가져오기 오류:", error);
        });

        return () => unsubscribe();
    }, [isAuthReady, db, userId]);

    // 파비콘 추가 (DOM 조작)
    useEffect(() => {
      const link = document.createElement('link');
      link.rel = 'icon';
      link.href = `data:image/svg+xml;charset=utf8,${encodeURIComponent(faviconSvg)}`;
      document.head.appendChild(link);
      return () => {
        document.head.removeChild(link);
      };
    }, []);

    const weekDays = ['일', '월', '화', '수', '목', '금', '토'];

    const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const days = [];

        // 이전 달의 마지막 날짜들
        const firstDayOfWeek = firstDayOfMonth.getDay();
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek; i > 0; i--) {
            days.push({
                day: prevMonthLastDay - i + 1,
                isCurrentMonth: false,
                date: new Date(year, month - 1, prevMonthLastDay - i + 1)
            });
        }

        // 현재 달의 날짜들
        for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
            days.push({
                day: i,
                isCurrentMonth: true,
                date: new Date(year, month, i)
            });
        }

        // 다음 달의 첫 날짜들
        const totalCells = 42; // 6주
        const remainingCells = totalCells - days.length;
        for (let i = 1; i <= remainingCells; i++) {
            days.push({
                day: i,
                isCurrentMonth: false,
                date: new Date(year, month + 1, i)
            });
        }

        return days;
    };

    const handlePrevMonth = () => {
        setCurrentDate(prevDate => new Date(prevDate.getFullYear(), prevDate.getMonth() - 1, 1));
    };

    const handleNextMonth = () => {
        setCurrentDate(prevDate => new Date(prevDate.getFullYear(), prevDate.getMonth() + 1, 1));
    };

    const handleDayClick = (dateInfo) => {
        setSelectedDate(dateInfo.date);
        setEditingEvent(null);
        setModalTitle('');
        setModalDescription('');
        setIsModalOpen(true);
    };

    const handleEditEvent = (event) => {
        setEditingEvent(event);
        setSelectedDate(new Date(event.date));
        setModalTitle(event.title);
        setModalDescription(event.description);
        setIsModalOpen(true);
    };

    const handleDeleteEvent = async (eventId) => {
        if (!userId || !db) return;
        const eventRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'events', eventId);
        try {
            await deleteDoc(eventRef);
        } catch (e) {
            console.error("이벤트 삭제 오류:", e);
        }
    };

    const handleModalSubmit = async () => {
        if (!modalTitle.trim() || !selectedDate || !userId || !db) return;

        const eventData = {
            title: modalTitle,
            description: modalDescription,
            date: selectedDate.toISOString().split('T')[0]
        };

        try {
            const eventsCollection = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'events');
            if (editingEvent) {
                const eventRef = doc(eventsCollection, editingEvent.id);
                await setDoc(eventRef, eventData);
            } else {
                await setDoc(doc(eventsCollection), eventData);
            }
        } catch (e) {
            console.error("이벤트 저장 오류:", e);
        }

        setIsModalOpen(false);
        setModalTitle('');
        setModalDescription('');
        setSelectedDate(null);
        setEditingEvent(null);
    };

    const getEventsForDate = (date) => {
        const dateString = date.toISOString().split('T')[0];
        return events.filter(event => event.date === dateString);
    };

    const days = getDaysInMonth(currentDate);

    return (
        <div className="flex justify-center items-center min-h-screen bg-gray-100 p-4 font-inter text-gray-800">
            <div className="w-full max-w-4xl p-6 bg-white shadow-xl rounded-2xl">
                {/* 헤더 */}
                <div className="flex justify-between items-center mb-6">
                    <button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <ChevronLeftIcon className="h-6 w-6 text-gray-500" />
                    </button>
                    <h2 className="text-2xl font-semibold text-center">
                        {currentDate.getFullYear()}년 {currentDate.getMonth() + 1}월
                    </h2>
                    <button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <ChevronRightIcon className="h-6 w-6 text-gray-500" />
                    </button>
                </div>
                {/* 요일 */}
                <div className="grid grid-cols-7 text-center font-medium text-sm text-gray-500 mb-2">
                    {weekDays.map(day => (
                        <div key={day}>{day}</div>
                    ))}
                </div>
                {/* 달력 그리드 */}
                <div className="grid grid-cols-7 gap-1">
                    {days.map((dayInfo, index) => (
                        <div
                            key={index}
                            className={`calendar-day-cell h-28 p-1 rounded-lg transition-colors flex flex-col overflow-y-auto ${
                                dayInfo.isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400'
                            } `}
                            onClick={() => dayInfo.isCurrentMonth && handleDayClick(dayInfo)}
                            style={{ minHeight: '112px' }}
                        >
                            <span className={`day-label text-sm font-semibold rounded-full w-8 h-8 flex items-center justify-center`}>
                                {dayInfo.day}
                            </span>
                            <div className="mt-1 space-y-1">
                                {getEventsForDate(dayInfo.date).map(event => (
                                    <div
                                        key={event.id}
                                        className="relative bg-indigo-500 text-white text-xs px-2 py-1 rounded-md cursor-pointer transition-all hover:bg-indigo-600 group"
                                        onClick={(e) => {
                                            e.stopPropagation(); // 부모 클릭 방지
                                            handleEditEvent(event);
                                        }}
                                    >
                                        <div className="truncate">{event.title}</div>
                                        <div className="absolute top-0 right-0 p-1 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={(e) => {
                                                e.stopPropagation();
                                                handleEditEvent(event);
                                            }} className="bg-indigo-700 p-1 rounded-full hover:bg-indigo-800 transition-colors">
                                                <PencilIcon className="w-3 h-3 text-white" />
                                            </button>
                                            <button onClick={(e) => {
                                                e.stopPropagation();
                                                handleDeleteEvent(event.id);
                                            }} className="bg-red-500 p-1 rounded-full hover:bg-red-600 transition-colors">
                                                <TrashIcon className="w-3 h-3 text-white" />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
            {/* 모달 */}
            {isModalOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl transition-transform-scale">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold">{editingEvent ? '이벤트 수정' : '새 이벤트 추가'}</h3>
                            <button onClick={() => setIsModalOpen(false)} className="p-1 rounded-full hover:bg-gray-200 transition-colors">
                                <XCircleIcon className="h-6 w-6 text-gray-500" />
                            </button>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700">날짜</label>
                            <p className="mt-1 p-2 bg-gray-100 rounded-md">{selectedDate.toLocaleDateString()}</p>
                        </div>
                        <div className="mb-4">
                            <label htmlFor="title" className="block text-sm font-medium text-gray-700">제목</label>
                            <input
                                type="text"
                                id="title"
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                value={modalTitle}
                                onChange={(e) => setModalTitle(e.target.value)}
                            />
                        </div>
                        <div className="mb-4">
                            <label htmlFor="description" className="block text-sm font-medium text-gray-700">설명 (선택 사항)</label>
                            <textarea
                                id="description"
                                rows="3"
                                className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"
                                value={modalDescription}
                                onChange={(e) => setModalDescription(e.target.value)}
                            ></textarea>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 rounded-full text-sm font-semibold bg-gray-200 hover:bg-gray-300 transition-colors">
                                취소
                            </button>
                            <button
                                onClick={handleModalSubmit}
                                className="px-4 py-2 rounded-full text-sm font-semibold text-white bg-indigo-500 hover:bg-indigo-600 transition-colors flex items-center space-x-1"
                            >
                                <CheckCircleIcon className="h-4 w-4" />
                                <span>저장</span>
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default App;
