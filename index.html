<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2인 교대 야간 근무표</title>
    <!-- Tailwind CSS CDN을 로드합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 및 ReactDOM CDN을 로드하여 React 앱을 브라우저에서 직접 실행합니다. -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel을 로드하여 JSX 문법을 변환합니다. -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs를 로드합니다. -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Canvas 환경에서 제공되는 전역 변수를 사용합니다.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.firebase = {
            app,
            db,
            auth,
            signInWithCustomToken,
            onAuthStateChanged,
            doc,
            setDoc,
            onSnapshot
        };
    </script>
</head>
<body className="bg-gray-100 font-sans leading-normal tracking-normal">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [data, setData] = useState(null);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [toastMessage, setToastMessage] = useState('');
            const [isToastVisible, setIsToastVisible] = useState(false);
            const [isError, setIsError] = useState(false);

            const isSaving = useRef(false);

            // Toast 메시지 표시 함수
            const showToast = (message, isError = false) => {
                setToastMessage(message);
                setIsError(isError);
                setIsToastVisible(true);
                setTimeout(() => {
                    setIsToastVisible(false);
                }, 3000); // 3초 후에 토스트 메시지를 숨깁니다.
            };

            // Firebase 초기화 및 인증
            useEffect(() => {
                const initFirebase = async () => {
                    const { auth, signInWithCustomToken, onAuthStateChanged } = window.firebase;
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                };

                const unsubscribe = onAuthStateChanged(window.firebase.auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        // 사용자 ID가 없는 경우 익명으로 로그인
                        window.firebase.signInAnonymously(window.firebase.auth)
                            .then(userCredential => {
                                setUserId(userCredential.user.uid);
                            })
                            .catch(error => {
                                console.error("Anonymous Sign-in Error:", error);
                            });
                    }
                    setIsAuthReady(true);
                });

                initFirebase();
                
                return () => unsubscribe();
            }, []);

            // Firestore 데이터 리스너 설정
            useEffect(() => {
                if (!isAuthReady || !userId) return;

                const { db, doc, onSnapshot } = window.firebase;
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'shift_schedules', 'schedule_data');

                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setData(docSnap.data());
                    } else {
                        setData(null);
                    }
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    showToast('데이터를 불러오는 데 실패했습니다.', true);
                });

                return () => unsubscribe();
            }, [isAuthReady, userId]);

            // 현재 날짜의 근무표 데이터 저장
            const handleSave = async () => {
                if (!isAuthReady || !userId || isSaving.current) {
                    showToast('데이터를 저장할 수 없습니다. 잠시 후 다시 시도해 주세요.', true);
                    return;
                }
                if (!data) {
                    showToast('저장할 데이터가 없습니다.', true);
                    return;
                }

                isSaving.current = true;
                const { db, doc, setDoc } = window.firebase;
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'shift_schedules', 'schedule_data');

                try {
                    await setDoc(userDocRef, data);
                    showToast('근무표가 성공적으로 저장되었습니다!');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showToast('근무표 저장에 실패했습니다.', true);
                } finally {
                    isSaving.current = false;
                }
            };

            // 다음 달로 이동
            const goToNextMonth = () => {
                setSelectedDate(prevDate => {
                    const newDate = new Date(prevDate);
                    newDate.setMonth(newDate.getMonth() + 1);
                    return newDate;
                });
            };

            // 이전 달로 이동
            const goToPreviousMonth = () => {
                setSelectedDate(prevDate => {
                    const newDate = new Date(prevDate);
                    newDate.setMonth(newDate.getMonth() - 1);
                    return newDate;
                });
            };

            // 근무표 데이터 생성 또는 업데이트
            const createCalendarData = (year, month) => {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday, 1 = Monday ...

                const schedule = data?.schedule || {};
                const dailyData = {};

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const dateString = date.toISOString().split('T')[0];
                    const existingDay = schedule[dateString];
                    dailyData[dateString] = {
                        date: date.getDate(),
                        dayOfWeek: date.getDay(),
                        name: existingDay?.name || 'A',
                        shift: existingDay?.shift || '근무'
                    };
                }
                return dailyData;
            };

            const dailyData = createCalendarData(selectedDate.getFullYear(), selectedDate.getMonth());

            // 근무표 셀 클릭 핸들러
            const handleCellClick = (dateString) => {
                if (!data) return;
                const newSchedule = { ...data.schedule };
                const day = newSchedule[dateString];
                
                if (day.shift === '근무') {
                    day.shift = '휴무';
                    day.name = day.name === 'A' ? 'B' : 'A';
                } else {
                    day.shift = '근무';
                    day.name = day.name === 'A' ? 'B' : 'A';
                }
                
                setData({ ...data, schedule: newSchedule });
            };

            // 주간 근무 패턴 제안 (예시)
            const getSuggestedPatterns = () => {
                return [
                    { label: '3일 근무 / 1일 휴무', pattern: ['근무', '근무', '근무', '휴무'] },
                    { label: '4일 근무 / 2일 휴무', pattern: ['근무', '근무', '근무', '근무', '휴무', '휴무'] },
                    { label: '2일 근무 / 2일 휴무', pattern: ['근무', '근무', '휴무', '휴무'] },
                ];
            };

            // 패턴 적용
            const applyPattern = (pattern) => {
                if (!data) return;
                const newSchedule = { ...data.schedule };
                const allDates = Object.keys(newSchedule).sort();
                let name = 'A';
                for (let i = 0; i < allDates.length; i++) {
                    const dateString = allDates[i];
                    const shiftStatus = pattern[i % pattern.length];
                    newSchedule[dateString].shift = shiftStatus;
                    if (shiftStatus === '근무') {
                        newSchedule[dateString].name = name;
                        name = name === 'A' ? 'B' : 'A';
                    } else {
                        newSchedule[dateString].name = '휴무';
                    }
                }
                setData({ ...data, schedule: newSchedule });
                showToast('근무 패턴이 적용되었습니다!');
            };

            // PDF 내보내기 기능 (임시)
            const handleExportToPDF = () => {
                showToast('PDF 내보내기 기능은 아직 지원되지 않습니다.');
            };

            // 달력 헤더 렌더링
            const renderCalendarHeader = () => {
                const month = selectedDate.getMonth() + 1;
                const year = selectedDate.getFullYear();
                const weekDays = ['일', '월', '화', '수', '목', '금', '토'];
                return (
                    <div className="flex flex-col">
                        <div className="flex justify-between items-center py-4 px-2 bg-white rounded-t-xl shadow-sm">
                            <button 
                                onClick={goToPreviousMonth}
                                className="text-gray-600 hover:text-orange-500 transition-colors duration-200"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <h2 className="text-xl md:text-2xl font-bold text-gray-800">{year}년 {month}월</h2>
                            <button 
                                onClick={goToNextMonth}
                                className="text-gray-600 hover:text-orange-500 transition-colors duration-200"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        <div className="grid grid-cols-7 text-center font-bold text-gray-500 mt-2">
                            {weekDays.map(day => (
                                <div key={day} className="py-2">{day}</div>
                            ))}
                        </div>
                    </div>
                );
            };

            // 달력 렌더링
            const renderCalendar = () => {
                const year = selectedDate.getFullYear();
                const month = selectedDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay();

                const calendarDays = [];
                // 이전 달의 빈 공간
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarDays.push(<div key={`empty-${i}`} className="p-2"></div>);
                }

                // 이번 달의 날짜들
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const dateString = date.toISOString().split('T')[0];
                    const dayData = dailyData[dateString];
                    
                    const shiftStatusClass = dayData?.shift === '근무' 
                        ? 'bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200' 
                        : 'bg-red-100 text-red-800 border-red-200 hover:bg-red-200';

                    const todayClass = date.toDateString() === new Date().toDateString() 
                        ? 'border-4 border-orange-500' 
                        : 'border';

                    calendarDays.push(
                        <div 
                            key={dateString}
                            className={`flex flex-col items-center justify-center p-2 rounded-lg cursor-pointer transition-colors duration-200 ${shiftStatusClass} ${todayClass}`}
                            onClick={() => handleCellClick(dateString)}
                        >
                            <p className="text-lg font-semibold">{i}</p>
                            {/* 모바일에서는 이름을 숨기고, sm 이상 화면에서만 표시 */}
                            <p className="hidden sm:block text-sm font-semibold">{dayData?.name}</p>
                            <p className="text-xs md:text-sm font-medium">{dayData?.shift}</p>
                        </div>
                    );
                }
                
                return (
                    <div className="bg-white rounded-xl shadow-lg p-4">
                        {renderCalendarHeader()}
                        <div className="grid grid-cols-7 gap-2 mt-4">
                            {calendarDays}
                        </div>
                    </div>
                );
            };

            // 제안된 패턴 버튼 렌더링
            const renderSuggestedDays = () => (
                <div className="space-y-2">
                    <h3 className="text-md font-semibold text-gray-700">추천 근무 패턴</h3>
                    <div className="flex flex-wrap gap-2">
                        {getSuggestedPatterns().map(pattern => (
                            <button
                                key={pattern.label}
                                className="bg-orange-500 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-orange-600 transition-colors duration-200 text-sm md:text-base"
                                onClick={() => applyPattern(pattern.pattern)}
                            >
                                {pattern.label}
                            </button>
                        ))}
                    </div>
                </div>
            );

            // 메인 컴포넌트 렌더링
            return (
                <div className="min-h-screen bg-gray-100 p-4 md:p-8 flex items-center justify-center">
                    <div className="w-full max-w-4xl space-y-6">
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                            <h1 className="text-2xl sm:text-3xl font-bold text-gray-800">2인 교대 야간 근무표</h1>
                            <div className="flex space-x-2">
                                <button 
                                    onClick={handleSave} 
                                    className="bg-green-500 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:bg-green-600 transition-colors duration-200 text-sm md:text-base"
                                >
                                    저장하기
                                </button>
                                <button 
                                    onClick={handleExportToPDF} 
                                    className="bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg hover:from-orange-600 hover:to-orange-700 transition-colors duration-200 text-sm md:text-base"
                                >
                                    PDF로 내보내기
                                </button>
                            </div>
                        </div>
                        
                        {renderSuggestedDays()}

                        {/* 근무표 표시 영역 */}
                        <div className="space-y-4">
                            {renderCalendar()}
                        </div>
                    </div>

                    {/* 화면 하단에 표시되는 커스텀 토스트 메시지 */}
                    {isToastVisible && (
                        <div 
                            className="fixed inset-x-0 bottom-4 z-10 flex items-center justify-center pointer-events-none"
                        >
                            <div 
                                className={`bg-white rounded-xl shadow-lg p-4 text-center transform transition-transform duration-300 ease-out 
                                    ${isError ? 'border-2 border-red-500' : 'border-2 border-green-500'}`}
                            >
                                <p className="text-gray-800 font-semibold">{toastMessage}</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // React 앱을 DOM에 렌더링합니다.
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
